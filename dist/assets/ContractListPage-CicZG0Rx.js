import{a7 as W,u as X,f as Y,r as o,j as e,B as d,t as k,v as b,w as T,x as Z,y as S,P as J,O as K,Q as ee,T as se,V as ae,W as c,b9 as re,n as D,X as te,Y as M,Z as E,_ as B,$ as H,a0 as I,ai as oe,I as ie,a9 as ne,s as m,at as le,H as de}from"./index-DHBNVHsv.js";import{T as ce,a as me,b as j,c as l,d as ue,e as i}from"./table-DvqSggFu.js";import{P as xe}from"./plus-circle-BRMk-46g.js";import{M as he}from"./more-horizontal-BCKriRg7.js";import{P as pe}from"./pen-square-BkMXMyrY.js";import{R as fe}from"./refresh-cw-CwaUc2my.js";import{F as je}from"./file-plus-D5b-ayUz.js";import{S as ge}from"./search-DbNcPKSo.js";import{H as we,G as Ce,B as Ne}from"./heart-handshake-Ba4m_KAX.js";import{B as ve}from"./baby-DWVw8W7p.js";import{C as ye}from"./cake-Ci3ZQGjc.js";const Oe=()=>{const{user:u,getClientById:O,refreshData:n,contratos:x}=W(),h=X(),{toast:r}=Y(),[g,w]=o.useState({}),[C,N]=o.useState(null),[P,p]=o.useState(!1),[L,f]=o.useState(!1),[$,A]=o.useState([]),[v,R]=o.useState("");o.useEffect(()=>{n("contratos")},[n]);const G=s=>{switch(s?.toLowerCase()){case"assinado":return"success";case"pendente":return"warning";case"recusado":return"destructive";case"draft":return"outline";default:return"secondary"}},V=async s=>{if(!s.id_assinatura_assinafy){r({title:"Atenção",description:"Este contrato não foi enviado para assinatura eletrônica.",variant:"destructive"});return}w(a=>({...a,[s.id]:!0}));try{const{data:a,error:t}=await m.functions.invoke("assinafy-check-status",{body:{documentId:s.id_assinatura_assinafy,user_id:u.id}});if(t)throw t;if(a.error)throw new Error(a.error);r({title:"Status atualizado!",description:`O status do contrato agora é: ${a.status}`}),await n("contratos")}catch(a){r({title:"Erro ao verificar status",description:a.message,variant:"destructive"})}finally{w(a=>({...a,[s.id]:!1}))}},q=async s=>{N(s);try{const{error:a}=await m.from("contratosgerados").delete().eq("id",s);if(a)throw a;r({title:"Sucesso",description:"Contrato excluído com sucesso."}),await n("contratos")}catch(a){r({title:"Erro",description:`Não foi possível excluir o contrato: ${a.message}`,variant:"destructive"})}finally{N(null)}},y=async s=>{if(p(!1),s==="blank")h("/studio/contracts/new");else{const{data:a,error:t}=await m.from("modeloscontrato").select("*").or("status.eq.publico",`user_id.eq.${u.id}`);if(t){r({title:"Erro",description:"Não foi possível carregar os modelos de contrato.",variant:"destructive"});return}A(a),f(!0)}},F=async s=>{f(!1);try{const{data:a,error:t}=await m.from("contratosgerados").insert({id_fotografo:u.id,id_modelo:s.id,titulo_contrato:`${s.nome_modelo} (Cópia)`,conteudo_final:s.conteudo_template,status_assinatura:"draft"}).select().single();if(t)throw t;await n("contratos"),h(`/studio/contracts/edit/${a.id}`)}catch(a){r({title:"Erro ao criar contrato do modelo",description:a.message,variant:"destructive"})}},_=s=>{h(`/studio/contracts/edit/${s.id}`)},z=s=>{(s.status_assinatura==="draft"||!s.status_assinatura)&&_(s)},U=s=>{const a=s.toLowerCase();return a.includes("casamento")||a.includes("noivos")?e.jsx(we,{className:"w-5 h-5 text-primary flex-shrink-0"}):a.includes("formatura")?e.jsx(Ce,{className:"w-5 h-5 text-primary flex-shrink-0"}):a.includes("parto")||a.includes("nascimento")||a.includes("newborn")?e.jsx(ve,{className:"w-5 h-5 text-primary flex-shrink-0"}):a.includes("aniversário")||a.includes("festa")?e.jsx(ye,{className:"w-5 h-5 text-primary flex-shrink-0"}):a.includes("ensaio")?e.jsx(le,{className:"w-5 h-5 text-primary flex-shrink-0"}):e.jsx(Ne,{className:"w-5 h-5 text-primary flex-shrink-0"})},Q=$.filter(s=>s.nome_modelo.toLowerCase().includes(v.toLowerCase()));return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Meus Contratos"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie todos os seus contratos gerados."})]}),e.jsxs(d,{onClick:()=>p(!0),children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Novo Contrato"]})]}),e.jsxs(k,{children:[e.jsxs(b,{children:[e.jsx(T,{children:"Lista de Contratos"}),e.jsx(Z,{children:"Visualize, acompanhe o status e gerencie seus contratos."})]}),e.jsx(S,{children:e.jsxs(ce,{children:[e.jsx(me,{children:e.jsxs(j,{children:[e.jsx(l,{children:"Título do Contrato"}),e.jsx(l,{children:"Cliente"}),e.jsx(l,{children:"Data de Geração"}),e.jsx(l,{children:"Status"}),e.jsx(l,{className:"text-right",children:"Ações"})]})}),e.jsx(ue,{children:x&&x.length>0?x.map(s=>e.jsxs(j,{onClick:()=>z(s),className:"cursor-pointer",children:[e.jsx(i,{className:"font-medium",children:s.titulo_contrato}),e.jsx(i,{children:O(s.id_cliente)?.name||"N/A"}),e.jsx(i,{children:J(new Date(s.data_geracao),"dd/MM/yyyy",{locale:de})}),e.jsx(i,{children:e.jsx(K,{variant:G(s.status_assinatura),children:s.status_assinatura||"Não enviado"})}),e.jsx(i,{className:"text-right",children:e.jsxs(ee,{children:[e.jsx(se,{asChild:!0,children:e.jsxs(d,{variant:"ghost",className:"h-8 w-8 p-0",onClick:a=>a.stopPropagation(),children:[e.jsx("span",{className:"sr-only",children:"Abrir menu"}),e.jsx(he,{className:"h-4 w-4"})]})}),e.jsxs(ae,{align:"end",onClick:a=>a.stopPropagation(),children:[e.jsxs(c,{onClick:()=>_(s),children:[e.jsx(pe,{className:"mr-2 h-4 w-4"}),"Editar"]}),s.link_documento_final_assinafy&&e.jsx(c,{asChild:!0,children:e.jsxs("a",{href:s.link_documento_final_assinafy,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),"Baixar Assinado"]})}),e.jsxs(c,{onClick:()=>V(s),disabled:g[s.id],children:[g[s.id]?e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(fe,{className:"mr-2 h-4 w-4"}),"Verificar Status"]}),e.jsxs(c,{onClick:()=>q(s.id),className:"text-red-500",disabled:C===s.id,children:[C===s.id?e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(te,{className:"mr-2 h-4 w-4"}),"Excluir"]})]})]})})]},s.id)):e.jsx(j,{children:e.jsx(i,{colSpan:"5",className:"h-24 text-center",children:"Nenhum contrato encontrado."})})})]})})]}),e.jsx(M,{open:P,onOpenChange:p,children:e.jsxs(E,{className:"sm:max-w-md",children:[e.jsxs(B,{children:[e.jsx(H,{children:"Criar Novo Contrato"}),e.jsx(I,{children:"Como você gostaria de começar?"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 py-4",children:[e.jsxs(d,{variant:"outline",className:"h-28 flex flex-col gap-2 text-center",onClick:()=>y("blank"),children:[e.jsx(je,{className:"w-8 h-8"}),e.jsx("span",{className:"text-sm font-medium",children:"Criar em Branco"})]}),e.jsxs(d,{variant:"outline",className:"h-28 flex flex-col gap-2 text-center",onClick:()=>y("template"),children:[e.jsx(oe,{className:"w-8 h-8"}),e.jsx("span",{className:"text-sm font-medium",children:"Usar um Modelo"})]})]})]})}),e.jsx(M,{open:L,onOpenChange:f,children:e.jsxs(E,{className:"sm:max-w-3xl h-[80vh] flex flex-col",children:[e.jsxs(B,{children:[e.jsx(H,{children:"Galeria de Modelos de Contrato"}),e.jsx(I,{children:"Escolha um modelo para começar. Você poderá editá-lo completamente."})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ie,{placeholder:"Buscar por nome ou nicho...",className:"pl-9",value:v,onChange:s=>R(s.target.value)})]}),e.jsx(ne,{className:"flex-grow pr-4 -mr-4",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 py-4",children:Q.map(s=>e.jsxs(k,{className:"cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200 flex flex-col",onClick:()=>F(s),children:[e.jsx(b,{className:"pb-2",children:e.jsxs(T,{className:"text-base flex items-start gap-2",children:[U(s.nome_modelo),e.jsx("span",{className:"flex-1",children:s.nome_modelo})]})}),e.jsx(S,{className:"flex-grow",children:e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-3",children:s.description||"Este modelo não possui uma descrição."})})]},s.id))})})]})})]})};export{Oe as default};

import{af as Y,u as ee,f as re,a3 as se,e as ae,r as n,aa as q,s as m,j as e,B as y,l as te,aP as oe,h as k,Z as O,_ as B,$ as R,a0 as A,a1 as u,I as _,a4 as ie,i as le,T as ne,ax as de}from"./index-hGCyqJo1.js";import{D as ce,C as me,P as ue}from"./dnd.esm-DP1zC3am.js";import{F as ge}from"./FormSuccessModal-PruJdiqW.js";import{A as he}from"./arrow-left-Dxkegdz9.js";import{U as Q}from"./upload-cloud-B1o_eFMa.js";import{G as pe}from"./grip-vertical-PEky4a8w.js";import"./defineProperty-DbXIQDXj.js";import"./typeof-QjJsDpFa.js";import"./extends-CF3RwP-h.js";import"./tiny-invariant-CopsF_GD.js";import"./share-2-lS9Up53B.js";import"./copy-DMpwDGdl.js";const Ee=()=>{const{formId:d}=Y(),v=ee(),w=re(),{user:g}=se(),{toast:j}=ae(),[l,b]=n.useState({title:"",description:"",logo_url:null,form_type:"client_registration",campaign_tag:"",background_image_url:null}),[N,f]=n.useState([]),[V,E]=n.useState(!0),[I,C]=n.useState(!1),[h,M]=n.useState(null),[p,z]=n.useState(null),[G,U]=n.useState(!1),[H,Z]=n.useState(""),S=n.useCallback(async()=>{if(d==="new"){if(w.state?.template){const r=w.state.template;b(s=>({...s,title:r.title||"",description:r.description||"",form_type:w.state.templateType||"client_registration"})),f(r.questions.map((s,a)=>({...s,id:q(),order:a})))}E(!1);return}E(!0);try{const{data:r,error:s}=await m.from("client_forms").select("*").eq("id",d).eq("user_id",g.id).single();if(s)throw s;b(r);const{data:a,error:o}=await m.from("form_questions").select("*").eq("form_id",d).order("order",{ascending:!0});if(o)throw o;f(a)}catch(r){j({title:"Erro ao carregar formulário",description:r.message,variant:"destructive"}),v("/forms")}finally{E(!1)}},[d,g,j,v,w.state]);n.useEffect(()=>{S()},[S]);const F=(r,s)=>b(a=>({...a,[r]:s})),L=(r,s,a)=>{f(o=>o.map(t=>t.id===r?{...t,[s]:a}:t))},J=()=>{const r={id:q(),form_id:d,user_id:g.id,question_text:"",question_type:"short_text",is_required:!1,order:N.length};f(s=>[...s,r])},K=r=>f(s=>s.filter(a=>a.id!==r)),W=r=>{if(!r.destination)return;const s=Array.from(N),[a]=s.splice(r.source.index,1);s.splice(r.destination.index,0,a);const o=s.map((t,c)=>({...t,order:c}));f(o)},$=async(r,s)=>{if(!r)return null;if(r.size>5*1024*1024)return j({title:"Arquivo muito grande",description:"O tamanho da imagem não pode exceder 5MB.",variant:"destructive"}),"error";const a=r.name.split(".").pop(),o=`${g.id}-${d||"new"}-${q()}.${a}`,t=`public/${g.id}/${s}/${o}`,{error:c}=await m.storage.from("user_assets").upload(t,r,{cacheControl:"3600",upsert:!0});if(c)throw c;const{data:P}=m.storage.from("user_assets").getPublicUrl(t);return P.publicUrl},X=async()=>{C(!0);try{let r=d,s=d==="new",a=l.shareable_link_id,o=l.logo_url,t=l.background_image_url;if(h){const i=await $(h,"form_logos");if(i==="error"){C(!1);return}o=i}if(p){const i=await $(p,"form_backgrounds");if(i==="error"){C(!1);return}t=i}const c={...l,user_id:g.id,logo_url:o,background_image_url:t};if(delete c.id,s){const{data:i,error:x}=await m.from("client_forms").insert(c).select().single();if(x)throw x;r=i.id,a=i.shareable_link_id,b(i)}else{const{data:i,error:x}=await m.from("client_forms").update(c).eq("id",d).select().single();if(x)throw x;b(i)}const P=N.map((i,x)=>({...i,form_id:r,user_id:g.id,order:i.order??x})),{error:D}=await m.from("form_questions").delete().eq("form_id",r);if(D)throw D;const{error:T}=await m.from("form_questions").upsert(P);if(T)throw T;j({title:"Formulário salvo com sucesso!"}),s?(Z(`${window.location.origin}/f/${a}`),U(!0),v(`/forms/edit/${r}`,{replace:!0})):S()}catch(r){j({title:"Erro ao salvar",description:r.message,variant:"destructive"})}finally{C(!1)}};return V?e.jsx("div",{children:"Carregando editor..."}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{isOpen:G,onClose:()=>U(!1),shareableLink:H}),e.jsxs("div",{className:"max-w-4xl mx-auto space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(y,{variant:"outline",onClick:()=>v("/forms"),children:[e.jsx(he,{className:"w-4 h-4 mr-2"})," Voltar"]}),e.jsx("h1",{className:"text-3xl font-bold text-foreground titulo-gradiente",children:"Editor de Formulário"}),e.jsxs(y,{onClick:X,disabled:I,children:[I?e.jsx(te,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Salvar"]})]}),e.jsxs("div",{className:"bg-card p-6 rounded-lg shadow-md border border-border space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Detalhes do Formulário"}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"form_type",children:"Tipo de Formulário"}),e.jsxs(O,{value:l.form_type,onValueChange:r=>F("form_type",r),children:[e.jsx(B,{id:"form_type",children:e.jsx(R,{})}),e.jsxs(A,{children:[e.jsx(u,{value:"client_registration",children:"Cadastro de Cliente"}),e.jsx(u,{value:"client_and_briefing",children:"Cadastro de Cliente + Briefing"}),e.jsx(u,{value:"lead_campaign",children:"Campanha de Leads"}),e.jsx(u,{value:"feedback",children:"Pesquisa de Feedback"})]})]})]}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"title",children:"Título"}),e.jsx(_,{id:"title",value:l.title,onChange:r=>F("title",r.target.value),placeholder:"Ex: Briefing de Casamento"})]}),l.form_type==="lead_campaign"&&e.jsxs("div",{children:[e.jsx(k,{htmlFor:"campaign_tag",children:"Etiqueta da Campanha"}),e.jsx(_,{id:"campaign_tag",value:l.campaign_tag||"",onChange:r=>F("campaign_tag",r.target.value),placeholder:"Ex: Expo Noivas 2024"})]}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"description",children:"Descrição"}),e.jsx(ie,{id:"description",value:l.description||"",onChange:r=>F("description",r.target.value),placeholder:"Instruções para o cliente"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-muted-foreground mb-1",children:"Logo (Opcional)"}),e.jsxs("div",{className:"flex items-center gap-4",children:[l.logo_url&&!h&&e.jsx("img",{src:l.logo_url,alt:"Logo",className:"h-16 w-auto rounded-md bg-muted p-1"}),h&&e.jsx("img",{src:URL.createObjectURL(h),alt:"Preview",className:"h-16 w-auto rounded-md bg-muted p-1"}),e.jsx(_,{type:"file",onChange:r=>M(r.target.files[0]),accept:"image/*",className:"hidden",id:"logo-upload"}),e.jsx("label",{htmlFor:"logo-upload",className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center gap-2 p-2 border border-dashed rounded-md hover:bg-accent",children:[e.jsx(Q,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:h?h.name:"Escolher arquivo"})]})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-muted-foreground mb-1",children:"Imagem de Fundo (Opcional)"}),e.jsxs("div",{className:"flex items-center gap-4",children:[l.background_image_url&&!p&&e.jsx("img",{src:l.background_image_url,alt:"Background",className:"h-16 w-auto rounded-md bg-muted p-1 object-cover"}),p&&e.jsx("img",{src:URL.createObjectURL(p),alt:"Preview",className:"h-16 w-auto rounded-md bg-muted p-1 object-cover"}),e.jsx(_,{type:"file",onChange:r=>z(r.target.files[0]),accept:"image/*",className:"hidden",id:"bg-image-upload"}),e.jsx("label",{htmlFor:"bg-image-upload",className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center gap-2 p-2 border border-dashed rounded-md hover:bg-accent",children:[e.jsx(Q,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:p?p.name:"Escolher arquivo"})]})})]})]})]})]}),e.jsxs("div",{className:"bg-card p-6 rounded-lg shadow-md border border-border space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Perguntas"}),e.jsx(ce,{onDragEnd:W,children:e.jsx(me,{droppableId:"questions",children:r=>e.jsxs("div",{...r.droppableProps,ref:r.innerRef,className:"space-y-4",children:[N.map((s,a)=>e.jsx(ue,{draggableId:String(s.id),index:a,children:o=>e.jsxs("div",{ref:o.innerRef,...o.draggableProps,className:"flex items-start gap-2 p-4 border rounded-md bg-background",children:[e.jsx("div",{...o.dragHandleProps,className:"pt-2 cursor-grab text-muted-foreground",children:e.jsx(pe,{})}),e.jsxs("div",{className:"flex-grow space-y-2",children:[e.jsx(_,{value:s.question_text,onChange:t=>L(s.id,"question_text",t.target.value),placeholder:"Digite sua pergunta"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{value:s.question_type,onValueChange:t=>L(s.id,"question_type",t),children:[e.jsx(B,{className:"w-[180px]",children:e.jsx(R,{})}),e.jsxs(A,{children:[e.jsx(u,{value:"short_text",children:"Texto Curto"}),e.jsx(u,{value:"long_text",children:"Texto Longo"}),e.jsx(u,{value:"email",children:"Email"}),e.jsx(u,{value:"phone",children:"Telefone"})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{id:`required-${s.id}`,checked:s.is_required,onCheckedChange:t=>L(s.id,"is_required",t)}),e.jsx("label",{htmlFor:`required-${s.id}`,className:"text-sm",children:"Obrigatório"})]}),e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>K(s.id),children:e.jsx(ne,{className:"w-4 h-4 text-destructive"})})]})]})]})]})},s.id)),r.placeholder]})})}),e.jsxs(y,{variant:"outline",onClick:J,className:"w-full",children:[e.jsx(de,{className:"w-4 h-4 mr-2"})," Adicionar Pergunta"]})]})]})]})};export{Ee as default};

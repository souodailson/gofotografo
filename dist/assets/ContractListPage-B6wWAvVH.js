import{a3 as K,u as Q,e as W,r as o,j as e,B as d,q as k,t as b,v as T,w as X,x as S,J as Y,K as Z,N as ee,O as se,P as c,b2 as ae,l as D,T as re,Q as M,V as E,W as B,X as I,Y as O,ae as te,I as oe,a5 as ie,s as m,av as ne}from"./index-DosJhT9z.js";import{T as le,a as de,b as j,c as l,d as ce,e as i}from"./table-RG_aE8wA.js";import{B as me}from"./badge-Bl6V8i8p.js";import{P as ue}from"./plus-circle-BCyIaDZs.js";import{M as xe}from"./more-horizontal-BHUkrYmU.js";import{P as he}from"./pen-square-B4TDd2Gh.js";import{R as pe}from"./refresh-cw-9D214xwP.js";import{F as fe}from"./file-plus-6k6Xejjp.js";import{S as je}from"./search-ByMMlkpH.js";import{H as ge,G as we,B as Ce,a as Ne}from"./heart-handshake-QJCtXt9O.js";import{C as ve}from"./cake-CkTIRtdz.js";import{p as ye}from"./pt-BR-Dqdi3X7i.js";const He=()=>{const{user:u,getClientById:P,refreshData:n,contratos:x}=K(),h=Q(),{toast:r}=W(),[g,w]=o.useState({}),[C,N]=o.useState(null),[H,p]=o.useState(!1),[L,f]=o.useState(!1),[A,R]=o.useState([]),[v,$]=o.useState("");o.useEffect(()=>{n("contratos")},[n]);const q=s=>{switch(s?.toLowerCase()){case"assinado":return"success";case"pendente":return"warning";case"recusado":return"destructive";case"draft":return"outline";default:return"secondary"}},G=async s=>{if(!s.id_assinatura_assinafy){r({title:"Atenção",description:"Este contrato não foi enviado para assinatura eletrônica.",variant:"destructive"});return}w(a=>({...a,[s.id]:!0}));try{const{data:a,error:t}=await m.functions.invoke("assinafy-check-status",{body:{documentId:s.id_assinatura_assinafy,user_id:u.id}});if(t)throw t;if(a.error)throw new Error(a.error);r({title:"Status atualizado!",description:`O status do contrato agora é: ${a.status}`}),await n("contratos")}catch(a){r({title:"Erro ao verificar status",description:a.message,variant:"destructive"})}finally{w(a=>({...a,[s.id]:!1}))}},V=async s=>{N(s);try{const{error:a}=await m.from("contratosgerados").delete().eq("id",s);if(a)throw a;r({title:"Sucesso",description:"Contrato excluído com sucesso."}),await n("contratos")}catch(a){r({title:"Erro",description:`Não foi possível excluir o contrato: ${a.message}`,variant:"destructive"})}finally{N(null)}},y=async s=>{if(p(!1),s==="blank")h("/studio/contracts/new");else{const{data:a,error:t}=await m.from("modeloscontrato").select("*").or("status.eq.publico",`user_id.eq.${u.id}`);if(t){r({title:"Erro",description:"Não foi possível carregar os modelos de contrato.",variant:"destructive"});return}R(a),f(!0)}},F=async s=>{f(!1);try{const{data:a,error:t}=await m.from("contratosgerados").insert({id_fotografo:u.id,id_modelo:s.id,titulo_contrato:`${s.nome_modelo} (Cópia)`,conteudo_final:s.conteudo_template,status_assinatura:"draft"}).select().single();if(t)throw t;await n("contratos"),h(`/studio/contracts/edit/${a.id}`)}catch(a){r({title:"Erro ao criar contrato do modelo",description:a.message,variant:"destructive"})}},_=s=>{h(`/studio/contracts/edit/${s.id}`)},z=s=>{(s.status_assinatura==="draft"||!s.status_assinatura)&&_(s)},U=s=>{const a=s.toLowerCase();return a.includes("casamento")||a.includes("noivos")?e.jsx(ge,{className:"w-5 h-5 text-primary flex-shrink-0"}):a.includes("formatura")?e.jsx(we,{className:"w-5 h-5 text-primary flex-shrink-0"}):a.includes("parto")||a.includes("nascimento")||a.includes("newborn")?e.jsx(Ce,{className:"w-5 h-5 text-primary flex-shrink-0"}):a.includes("aniversário")||a.includes("festa")?e.jsx(ve,{className:"w-5 h-5 text-primary flex-shrink-0"}):a.includes("ensaio")?e.jsx(ne,{className:"w-5 h-5 text-primary flex-shrink-0"}):e.jsx(Ne,{className:"w-5 h-5 text-primary flex-shrink-0"})},J=A.filter(s=>s.nome_modelo.toLowerCase().includes(v.toLowerCase()));return e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Meus Contratos"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie todos os seus contratos gerados."})]}),e.jsxs(d,{onClick:()=>p(!0),children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Novo Contrato"]})]}),e.jsxs(k,{children:[e.jsxs(b,{children:[e.jsx(T,{children:"Lista de Contratos"}),e.jsx(X,{children:"Visualize, acompanhe o status e gerencie seus contratos."})]}),e.jsx(S,{children:e.jsxs(le,{children:[e.jsx(de,{children:e.jsxs(j,{children:[e.jsx(l,{children:"Título do Contrato"}),e.jsx(l,{children:"Cliente"}),e.jsx(l,{children:"Data de Geração"}),e.jsx(l,{children:"Status"}),e.jsx(l,{className:"text-right",children:"Ações"})]})}),e.jsx(ce,{children:x&&x.length>0?x.map(s=>e.jsxs(j,{onClick:()=>z(s),className:"cursor-pointer",children:[e.jsx(i,{className:"font-medium",children:s.titulo_contrato}),e.jsx(i,{children:P(s.id_cliente)?.name||"N/A"}),e.jsx(i,{children:Y(new Date(s.data_geracao),"dd/MM/yyyy",{locale:ye})}),e.jsx(i,{children:e.jsx(me,{variant:q(s.status_assinatura),children:s.status_assinatura||"Não enviado"})}),e.jsx(i,{className:"text-right",children:e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(d,{variant:"ghost",className:"h-8 w-8 p-0",onClick:a=>a.stopPropagation(),children:[e.jsx("span",{className:"sr-only",children:"Abrir menu"}),e.jsx(xe,{className:"h-4 w-4"})]})}),e.jsxs(se,{align:"end",onClick:a=>a.stopPropagation(),children:[e.jsxs(c,{onClick:()=>_(s),children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),"Editar"]}),s.link_documento_final_assinafy&&e.jsx(c,{asChild:!0,children:e.jsxs("a",{href:s.link_documento_final_assinafy,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"}),"Baixar Assinado"]})}),e.jsxs(c,{onClick:()=>G(s),disabled:g[s.id],children:[g[s.id]?e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(pe,{className:"mr-2 h-4 w-4"}),"Verificar Status"]}),e.jsxs(c,{onClick:()=>V(s.id),className:"text-red-500",disabled:C===s.id,children:[C===s.id?e.jsx(D,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(re,{className:"mr-2 h-4 w-4"}),"Excluir"]})]})]})})]},s.id)):e.jsx(j,{children:e.jsx(i,{colSpan:"5",className:"h-24 text-center",children:"Nenhum contrato encontrado."})})})]})})]}),e.jsx(M,{open:H,onOpenChange:p,children:e.jsxs(E,{className:"sm:max-w-md",children:[e.jsxs(B,{children:[e.jsx(I,{children:"Criar Novo Contrato"}),e.jsx(O,{children:"Como você gostaria de começar?"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 py-4",children:[e.jsxs(d,{variant:"outline",className:"h-28 flex flex-col gap-2 text-center",onClick:()=>y("blank"),children:[e.jsx(fe,{className:"w-8 h-8"}),e.jsx("span",{className:"text-sm font-medium",children:"Criar em Branco"})]}),e.jsxs(d,{variant:"outline",className:"h-28 flex flex-col gap-2 text-center",onClick:()=>y("template"),children:[e.jsx(te,{className:"w-8 h-8"}),e.jsx("span",{className:"text-sm font-medium",children:"Usar um Modelo"})]})]})]})}),e.jsx(M,{open:L,onOpenChange:f,children:e.jsxs(E,{className:"sm:max-w-3xl h-[80vh] flex flex-col",children:[e.jsxs(B,{children:[e.jsx(I,{children:"Galeria de Modelos de Contrato"}),e.jsx(O,{children:"Escolha um modelo para começar. Você poderá editá-lo completamente."})]}),e.jsxs("div",{className:"relative",children:[e.jsx(je,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(oe,{placeholder:"Buscar por nome ou nicho...",className:"pl-9",value:v,onChange:s=>$(s.target.value)})]}),e.jsx(ie,{className:"flex-grow pr-4 -mr-4",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 py-4",children:J.map(s=>e.jsxs(k,{className:"cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200 flex flex-col",onClick:()=>F(s),children:[e.jsx(b,{className:"pb-2",children:e.jsxs(T,{className:"text-base flex items-start gap-2",children:[U(s.nome_modelo),e.jsx("span",{className:"flex-1",children:s.nome_modelo})]})}),e.jsx(S,{className:"flex-grow",children:e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-3",children:s.description||"Este modelo não possui uma descrição."})})]},s.id))})})]})})]})};export{He as default};

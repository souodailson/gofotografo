import{aj as Z,u as ee,g as se,a7 as re,f as ae,r as n,ae as I,s as m,j as e,B as y,e as te,n as oe,aU as ie,i as k,a1 as O,a2 as B,a3 as R,a4 as Q,a5 as u,I as _,a8 as le,k as ne,X as de,aC as ce}from"./index-DHBNVHsv.js";import{D as me,C as ue,P as ge}from"./dnd.esm-a4hrAlJG.js";import{F as he}from"./FormSuccessModal-CnGmDFo6.js";import{U as A}from"./upload-cloud-BqWdOYr3.js";import{G as xe}from"./grip-vertical-Cr0groAW.js";import"./defineProperty-f6N_0mpf.js";import"./extends-CF3RwP-h.js";import"./tiny-invariant-CopsF_GD.js";import"./share-2-YgEUnj0u.js";import"./copy-Ydl0eOtw.js";const ye=()=>{const{formId:d}=Z(),v=ee(),w=se(),{user:g}=re(),{toast:j}=ae(),[l,b]=n.useState({title:"",description:"",logo_url:null,form_type:"client_registration",campaign_tag:"",background_image_url:null}),[N,f]=n.useState([]),[V,E]=n.useState(!0),[P,C]=n.useState(!1),[h,M]=n.useState(null),[x,z]=n.useState(null),[G,U]=n.useState(!1),[H,X]=n.useState(""),S=n.useCallback(async()=>{if(d==="new"){if(w.state?.template){const s=w.state.template;b(r=>({...r,title:s.title||"",description:s.description||"",form_type:w.state.templateType||"client_registration"})),f(s.questions.map((r,a)=>({...r,id:I(),order:a})))}E(!1);return}E(!0);try{const{data:s,error:r}=await m.from("client_forms").select("*").eq("id",d).eq("user_id",g.id).single();if(r)throw r;b(s);const{data:a,error:o}=await m.from("form_questions").select("*").eq("form_id",d).order("order",{ascending:!0});if(o)throw o;f(a)}catch(s){j({title:"Erro ao carregar formulário",description:s.message,variant:"destructive"}),v("/forms")}finally{E(!1)}},[d,g,j,v,w.state]);n.useEffect(()=>{S()},[S]);const F=(s,r)=>b(a=>({...a,[s]:r})),L=(s,r,a)=>{f(o=>o.map(t=>t.id===s?{...t,[r]:a}:t))},J=()=>{const s={id:I(),form_id:d,user_id:g.id,question_text:"",question_type:"short_text",is_required:!1,order:N.length};f(r=>[...r,s])},K=s=>f(r=>r.filter(a=>a.id!==s)),W=s=>{if(!s.destination)return;const r=Array.from(N),[a]=r.splice(s.source.index,1);r.splice(s.destination.index,0,a);const o=r.map((t,c)=>({...t,order:c}));f(o)},D=async(s,r)=>{if(!s)return null;if(s.size>5*1024*1024)return j({title:"Arquivo muito grande",description:"O tamanho da imagem não pode exceder 5MB.",variant:"destructive"}),"error";const a=s.name.split(".").pop(),o=`${g.id}-${d||"new"}-${I()}.${a}`,t=`public/${g.id}/${r}/${o}`,{error:c}=await m.storage.from("user_assets").upload(t,s,{cacheControl:"3600",upsert:!0});if(c)throw c;const{data:q}=m.storage.from("user_assets").getPublicUrl(t);return q.publicUrl},Y=async()=>{C(!0);try{let s=d,r=d==="new",a=l.shareable_link_id,o=l.logo_url,t=l.background_image_url;if(h){const i=await D(h,"form_logos");if(i==="error"){C(!1);return}o=i}if(x){const i=await D(x,"form_backgrounds");if(i==="error"){C(!1);return}t=i}const c={...l,user_id:g.id,logo_url:o,background_image_url:t};if(delete c.id,r){const{data:i,error:p}=await m.from("client_forms").insert(c).select().single();if(p)throw p;s=i.id,a=i.shareable_link_id,b(i)}else{const{data:i,error:p}=await m.from("client_forms").update(c).eq("id",d).select().single();if(p)throw p;b(i)}const q=N.map((i,p)=>({...i,form_id:s,user_id:g.id,order:i.order??p})),{error:$}=await m.from("form_questions").delete().eq("form_id",s);if($)throw $;const{error:T}=await m.from("form_questions").upsert(q);if(T)throw T;j({title:"Formulário salvo com sucesso!"}),r?(X(`${window.location.origin}/f/${a}`),U(!0),v(`/forms/edit/${s}`,{replace:!0})):S()}catch(s){j({title:"Erro ao salvar",description:s.message,variant:"destructive"})}finally{C(!1)}};return V?e.jsx("div",{children:"Carregando editor..."}):e.jsxs(e.Fragment,{children:[e.jsx(he,{isOpen:G,onClose:()=>U(!1),shareableLink:H}),e.jsxs("div",{className:"max-w-4xl mx-auto space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(y,{variant:"outline",onClick:()=>v("/forms"),children:[e.jsx(te,{className:"w-4 h-4 mr-2"})," Voltar"]}),e.jsx("h1",{className:"text-3xl font-bold text-foreground titulo-gradiente",children:"Editor de Formulário"}),e.jsxs(y,{onClick:Y,disabled:P,children:[P?e.jsx(oe,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Salvar"]})]}),e.jsxs("div",{className:"bg-card p-6 rounded-lg shadow-md border border-border space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Detalhes do Formulário"}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"form_type",children:"Tipo de Formulário"}),e.jsxs(O,{value:l.form_type,onValueChange:s=>F("form_type",s),children:[e.jsx(B,{id:"form_type",children:e.jsx(R,{})}),e.jsxs(Q,{children:[e.jsx(u,{value:"client_registration",children:"Cadastro de Cliente"}),e.jsx(u,{value:"client_and_briefing",children:"Cadastro de Cliente + Briefing"}),e.jsx(u,{value:"lead_campaign",children:"Campanha de Leads"}),e.jsx(u,{value:"feedback",children:"Pesquisa de Feedback"})]})]})]}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"title",children:"Título"}),e.jsx(_,{id:"title",value:l.title,onChange:s=>F("title",s.target.value),placeholder:"Ex: Briefing de Casamento"})]}),l.form_type==="lead_campaign"&&e.jsxs("div",{children:[e.jsx(k,{htmlFor:"campaign_tag",children:"Etiqueta da Campanha"}),e.jsx(_,{id:"campaign_tag",value:l.campaign_tag||"",onChange:s=>F("campaign_tag",s.target.value),placeholder:"Ex: Expo Noivas 2024"})]}),e.jsxs("div",{children:[e.jsx(k,{htmlFor:"description",children:"Descrição"}),e.jsx(le,{id:"description",value:l.description||"",onChange:s=>F("description",s.target.value),placeholder:"Instruções para o cliente"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-muted-foreground mb-1",children:"Logo (Opcional)"}),e.jsxs("div",{className:"flex items-center gap-4",children:[l.logo_url&&!h&&e.jsx("img",{src:l.logo_url,alt:"Logo",className:"h-16 w-auto rounded-md bg-muted p-1"}),h&&e.jsx("img",{src:URL.createObjectURL(h),alt:"Preview",className:"h-16 w-auto rounded-md bg-muted p-1"}),e.jsx(_,{type:"file",onChange:s=>M(s.target.files[0]),accept:"image/*",className:"hidden",id:"logo-upload"}),e.jsx("label",{htmlFor:"logo-upload",className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center gap-2 p-2 border border-dashed rounded-md hover:bg-accent",children:[e.jsx(A,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:h?h.name:"Escolher arquivo"})]})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-muted-foreground mb-1",children:"Imagem de Fundo (Opcional)"}),e.jsxs("div",{className:"flex items-center gap-4",children:[l.background_image_url&&!x&&e.jsx("img",{src:l.background_image_url,alt:"Background",className:"h-16 w-auto rounded-md bg-muted p-1 object-cover"}),x&&e.jsx("img",{src:URL.createObjectURL(x),alt:"Preview",className:"h-16 w-auto rounded-md bg-muted p-1 object-cover"}),e.jsx(_,{type:"file",onChange:s=>z(s.target.files[0]),accept:"image/*",className:"hidden",id:"bg-image-upload"}),e.jsx("label",{htmlFor:"bg-image-upload",className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center gap-2 p-2 border border-dashed rounded-md hover:bg-accent",children:[e.jsx(A,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:x?x.name:"Escolher arquivo"})]})})]})]})]})]}),e.jsxs("div",{className:"bg-card p-6 rounded-lg shadow-md border border-border space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Perguntas"}),e.jsx(me,{onDragEnd:W,children:e.jsx(ue,{droppableId:"questions",children:s=>e.jsxs("div",{...s.droppableProps,ref:s.innerRef,className:"space-y-4",children:[N.map((r,a)=>e.jsx(ge,{draggableId:String(r.id),index:a,children:o=>e.jsxs("div",{ref:o.innerRef,...o.draggableProps,className:"flex items-start gap-2 p-4 border rounded-md bg-background",children:[e.jsx("div",{...o.dragHandleProps,className:"pt-2 cursor-grab text-muted-foreground",children:e.jsx(xe,{})}),e.jsxs("div",{className:"flex-grow space-y-2",children:[e.jsx(_,{value:r.question_text,onChange:t=>L(r.id,"question_text",t.target.value),placeholder:"Digite sua pergunta"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{value:r.question_type,onValueChange:t=>L(r.id,"question_type",t),children:[e.jsx(B,{className:"w-[180px]",children:e.jsx(R,{})}),e.jsxs(Q,{children:[e.jsx(u,{value:"short_text",children:"Texto Curto"}),e.jsx(u,{value:"long_text",children:"Texto Longo"}),e.jsx(u,{value:"email",children:"Email"}),e.jsx(u,{value:"phone",children:"Telefone"})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{id:`required-${r.id}`,checked:r.is_required,onCheckedChange:t=>L(r.id,"is_required",t)}),e.jsx("label",{htmlFor:`required-${r.id}`,className:"text-sm",children:"Obrigatório"})]}),e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>K(r.id),children:e.jsx(de,{className:"w-4 h-4 text-destructive"})})]})]})]})]})},r.id)),s.placeholder]})})}),e.jsxs(y,{variant:"outline",onClick:J,className:"w-full",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"})," Adicionar Pergunta"]})]})]})]})};export{ye as default};
